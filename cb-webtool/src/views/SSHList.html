{{ template "Top" .}}

<div id="lnb">

    <div class="bg"></div>

    <div class="m_box">


        {{template "Top_box" .}}

        {{template "LNB_popup" .}}

        <!-- menu -->
        <div class="leftmenu">

            <ul class="nav">
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#Operation">Operation</a></li>
                <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#Setting">Setting</a></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade" id="Operation">
                    <ul class="menu">
                        <li>
                            <a href="javascript:void(0);">Dashboard</a>
                            <ul>
                                <li><a href="/assets/operation/Dashboard_Ns.html">NS</a></li>
                                <li><a href="/assets/operation/Dashboard_Global.html">Global</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="javascript:void(0);">Manage</a>
                            <ul>
                                <li><a href="/assets/operation/Manage_Mcis.html">MCIS</a></li>
                                <li><a href="/assets/operation/Manage_McApp.html">MC-App</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="javascript:void(0);">Monitoring</a>
                            <ul>
                                <li><a href="/assets/operation/Monitoring_Mcis.html">MCIS</a></li>
                                <li><a href="/assets/operation/Monitoring_McApp.html">MC-App</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="javascript:void(0);">Policy</a>
                            <ul>
                                <li><a href="/assets/operation/Policy_Monitoring.html">Monitoring</a></li>
                                <li><a href="/assets/operation/Policy_Threshold.html">Threshold</a></li>
                                <li><a href="/assets/operation/Policy_Placement.html">Placement</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="javascript:void(0);">About</a>
                            <ul>
                                <li><a href="/assets/operation/About.html">About</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="tab-pane fade show active" id="Setting">
                    <ul class="menu">
                        <li class="active">
                            <a href="javascript:void(0);">Resources</a>
                            <ul>
                                <li><a href="/Vpc/list">Network</a></li>
                                <li><a href="/SecurityGroup/list">Security</a></li>
                                <li class="on"><a href="/SSH/list">SSH key</a></li>
                                <li><a href="/Image/list">(Server) Image</a></li>
                                <li><a href="/Spec/list">(Server) Spec</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="javascript:void(0);">App Resource</a>
                            <ul>
                                <li><a href="/assets/setting/AppResource_Image.html">(Server) Image</a></li>
                                <li><a href="/assets/setting/AppResource_Pod.html">Pod</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="javascript:void(0);">Cloud Connections</a>
                            <ul>
                                <li><a href="/assets/setting/CloudConnections.html">Cloud Connections</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="javascript:void(0);">NameSpace</a>
                            <ul>
                                <li><a href="/NameSpace/NS/list">NameSpace</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
        <!-- //menu -->

    </div>

    <div class="bottom"></div>
    <a href="javascript:;" id="m_close"></a>

</div>


{{template "Header" .}}

{{template "Modal" .}}

<!-- contents -->
<div class="contbox">

    <div class="titlebox">
        <div class="tit"><img src="/assets/img/common/icon_cont.png" alt="" />Resources / <strong>SSH key</strong></div>
        <div class="location">Home <span>></span> Setting <span>></span> Resources <span>></span> <strong>SSH key</strong></div>
    </div>



    <!-- list -->
    <div class="dashboard dashboard_cont">

        <div class="d_box box_m box_w100">
            <div class="titbox">
                <div class="tit initial"><strong>Server SSH key</strong></div>
                <div class="top_info">
                    <ul>
                        <li>
                            <a href="javascript:void(0);">Filter</a>
                            <div class="infobox">
                                <div class="box">
                                    <ul>
                                        <li><a href="javascript:void(0);">Name</a></li>
                                        <li><a href="javascript:void(0);">Connection Name</a></li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                        <li>
                            <a href="javascript:void(0);">Sort</a>
                            <div class="infobox">
                                <div class="box">
                                    <ul>
                                        <li><a href="javascript:void(0);" onclick='getSSHList("name")'>Name</a></li>
                                        <li><a href="javascript:void(0);" onclick='getSSHList("connectionName")'>Connection Name</a></li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                        <li>
                            <a href="javascript:void(0);">Action</a>
                            <div class="infobox">
                                <div class="box">
                                    <ul>
                                        <li><a href="javascript:void(0);" data-toggle="modal" data-target="#RegistBox">Add</a></li>
                                        <li><a href="javascript:void(0);" data-toggle="modal" data-target="#UnRegist">Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                        <li><a href="javascript:void(0);"><img src="/assets/img/common/icon_question.png" alt="" /></a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- popup Regist -->
            <div class="modal fade layerpopup" id="RegistBox" tabindex="-1" role="dialog" aria-hidden="true" id="modal_reg">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">

                        <div class="modal-body">
                            <div class="txt">Would you like to register SSH key <br />Resource ?</div>
                            <div class="btnbox">
                                <button type="button" class="btn_cancel" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn_ok register" onClick="goFocus('reg_cspSshKeyName')" data-dismiss="modal">OK</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <!-- //popup Regist -->

            <!-- popup UnRegist -->
							<div class="modal fade layerpopup" id="UnRegist" tabindex="-1" role="dialog" aria-hidden="true">
								<div class="modal-dialog" role="document">
									<div class="modal-content">
										
										<div class="modal-body">
											<div class="txt">Would you like to un-register SSH key <br />Resource ?</div>
											<div class="btnbox">
												<button type="button" class="btn_cancel" data-dismiss="modal">Cancel</button>
												<button type="button" class="btn_ok" onclick="goDelete('reg_cspSshKeyName')" data-dismiss="modal">OK</button>
											</div>
										</div>
										
									</div>
								</div>
							</div>
            <!-- //popup UnRegist -->

            <script>
                $(document).ready(function () {
                    //action register open / table view close
                    $('#RegistBox .btn_ok.register').click(function () {
                        $(".dashboard.register_cont").toggleClass("active");
                        $(".dashboard.server_status").removeClass("view");
                        $(".dashboard .status_list tbody tr").removeClass("on");
                        //ok 위치이동
                        $('#RegistBox').on('hidden.bs.modal', function () {
                            var offset = $("#CreateBox").offset();
                            $("#wrap").animate({
                                scrollTop: offset.top
                            }, 300);
                        })
                    });
                });
            </script>

            <div class="ds_cont">

                <div class="dataTable status_list">
                    <table cellpadding="0" cellspacing="0" border="1" summary="">
                        <colgroup>
                            <col width="50px">
                            <col width="">
                            <col width="">
                            <col width="">
                            <col width="60px">
                        </colgroup>
                        <thead>
                            <tr>
                                <th><input type="checkbox" name="" value="" id="th_chall" title="" /><label for="th_chall"></label></td>
                                <th>Name</th>
                                <th>Connection Name</th>
                                <th>SSH KEY Name</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="sList">
                            <!--
                            <tr>
                                <td class="overlay hidden" data-th=""><input type="checkbox" name="chk" value="" id="td_ch1" title="" /><label for="td_ch1"></label> <span class="ov off"></span></td>
                                <td class="btn_mtd ovm" data-th="name">name <span class="ov"></span></td>
                                <td class="overlay hidden" data-th="Connection Name">Connection Name</td>
                                <td class="overlay hidden" data-th="SSH KEY Name">SSH KEY Name</td>
                                <td class="overlay hidden" data-th=""><a href="javascript:void(0);"><img src="/assets/img/contents/icon_link.png" class="icon" alt="" /></a></td>
                            </tr>
                            -->
                        </tbody>
                    </table>
                </div>

                <script>
                    /* scroll */
                    $(document).ready(function () {
                        //checkbox all
                        $("#th_chall").click(function () {
                            if ($("#th_chall").prop("checked")) {
                                $("input[name=chk]").prop("checked", true);
                            } else {
                                $("input[name=chk]").prop("checked", false);
                            }
                        })

                        //table 스크롤바 제한
                        $(window).on("load resize", function () {
                            var vpwidth = $(window).width();
                            if (vpwidth > 768 && vpwidth < 1800) {
                                $(".dashboard_cont .dataTable").addClass("scrollbar-inner");
                                $(".dataTable.scrollbar-inner").scrollbar();
                            } else {
                                $(".dashboard_cont .dataTable").removeClass("scrollbar-inner");
                            }
                        });
                    });
                </script>

                                <!--
								<div class="pageing">
									<a href="#" class="btn_prev"><span>이전</span></a>
									<a href="#" class="active">1</a>
									<a href="#">2</a>
									<a href="#">3</a>
									<a href="#">4</a>
									<a href="#">5</a>
									<a href="#" class="btn_next"><span>다음</span></a>
								</div>
								-->
            </div>

        </div>

    </div>
    <!-- //list -->

<!-- Modify -->
<div class="dashboard dashboard_cont server_status" id="info_box">

    <div class="d_box box_m box_w100">
        <div class="titbox_n">
            <div class="tit initial"><strong>SSH Key Info</strong> <span class="stxt">[SG ID]</span></div>
        </div>

        <div class="ds_cont">
            <div class="register_box">

                <div class="top_ipbox">
                    <div class="ipbox ipbox1">
                        <ul>
                            <li class="reg_1">
                                <label>SSH Key Name</label>
                                <span class="sbox">
                                    <input type="text" id="dtlCspSshKeyName" name="" value="" placeholder="" class="gray" title="" readonly />
                                    <!--<a href="javascript:void(0);"><img src="/assets/img/contents/icon_copy.png" class="icon" alt="" /></a>-->
                                </span>
                            </li>
                            <li class="reg_1">
                                <label>Description</label>
                                <textarea id="dtlDescription" cols="" rows="" placeholder="" class="gray" title="" readonly></textarea>
                            </li>
                        </ul>
                    </div>
                    <div class="ipbox ipbox2">
                        <ul>
                            <li class="reg_3">
                                <label>Connection Name</label>
                                <input type="text" id="dtlConnectionName" name="" value="" placeholder="" class="gray" title="" readonly />
                            </li>
                            <li class="reg_3">
                                <label>publicKey</label>
                                <input type="text" id="dtlPublicKey" name="" value="" placeholder="" class="gray" title="" readonly />
                            </li>
                            <li class="reg_3">
                                <label>privateKey</label>
                                <textarea id="dtlPrivateKey" cols="" rows="" placeholder="" class="gray" title="" readonly></textarea>
                                <!-- <input type="text" id="dtlPrivateKey" name="" value="" placeholder="" class="gray" title="" readonly /> -->
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="top_ipbox bottom_ipbox">
                    <div class="ipbox ipbox1">
                        <ul>
                            <li class="reg_1">
                                <label>username</label>
                                <input type="text" id="dtlUsername" name="" value="" placeholder="" class="gray" title="" readonly />
                            </li>
                        </ul>
                    </div>
                    <div class="ipbox ipbox2">
                        <ul>
                            <li class="reg_3">
                                <label>fingerprint</label>
                                <!-- <input type="text" name="" value="" placeholder="fingerprint" class="gray" title="" readonly /> -->
                                <textarea id="dtlFingerprint" cols="" rows="" placeholder="" class="gray" title="" readonly></textarea>
                            </li>
                        </ul>
                    </div>
                </div>


                <div class="btnbox">
                    <div class="btn_center">
                        <button name="" value="" class="btn_co btn_cr_b w135 btn_cancel">Cancel</button>
                        <button name="" value="" class="btn_co btn_cr_g w135 btn_modify">Modify</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

</div>
<!-- //Modify -->

<!-- Register Security -->
<div class="dashboard dashboard_cont register_cont" id="CreateBox">

    <div class="d_box box_m box_w100">
        <div class="titbox_n">
            <div class="tit initial cg"><strong>Register SSH Key</strong></div>
        </div>

        <div class="ds_cont">
            <div class="register_box reg">

                <div class="top_ipbox">
                    <div class="ipbox ipbox1">
                        <ul>
                            <li class="reg_1">
                                <label><span class="ch">*</span>SSH Key Name</label>
                                <input type="text" name="reg_cspSshKeyName" id="reg_cspSshKeyName" value="" placeholder="Input Name" class="pline" title="" />
                            </li>
                        </ul>
                    </div>
                    <div class="ipbox ipbox2">
                        <ul>
                            <li class="reg_3">
                                <label>Cloud Provider</label>
                                <!-- <input type="text" name="" value="" placeholder="AWS, AZURE, GCP, ALIBABA / Region" class="pline" title="" /> -->
                                <select class="selectbox white pline w3" name="ProviderName" id="provider" onchange="getConnectionInfo(this.value)">
                                    <option selected>Select Cloud Provider</option>
                                    <option value="AWS">AWS</option>
                                    <option value="AZURE">AZURE</option>
                                    <option value="Alibaba">Alibaba</option>
                                    <option value="GCP">GCP</option>
                                    <option value="Cloudit">Cloudit</option>
                                    <option value="Openstack">Openstack</option>
                                </select>    
                            </li>
                            
                            <li class="reg_3">
                                <label><span class="ch">*</span>Connection Name</label>
                                <!-- <input type="text" name="" value="" placeholder="Select / Input fingerprint" class="pline ip_w1" title="" /> -->
                                <!-- <textarea cols="" rows="" placeholder="Description" class="pline ip_w1" title="" readonly></textarea> -->
                                <select class="selectbox white pline w3" name="reg_connectionName" id="reg_connectionName" >
                                    <option selected>Select Connection Name</option>
                                </select>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="btnbox">
                    <div class="btn_center">
                        <button name="" value="" class="btn_co btn_cr_b w135 btn_cancel">Cancel</button>
                        <button name="" value="" class="btn_co btn_cr_g w135 btn_ok" onclick="createSSHKey()">Ok</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

</div>
<!-- //Register Security -->

</div>
<!-- //contents -->
<script>
    $(document).ready(function () {
        order_type = "name"
        getSSHList(order_type);
    })


    function fnMove(target) {
        var offset = $("#" + target).offset();
        console.log("fn move offset : ", offset)
        $('html, body').animate({
            scrollTop: offset.top
        }, 400);
    }


    function getSSHList(sort_type) {
        //var url = "{{ .comURL.SpiderURL}}" + "/connectionconfig";
        var url = CommonURL+"/ns/"+NAMESPACE+"/resources/sshKey";
        axios.get(url, {
            headers: {
                'Authorization': "{{ .apiInfo}}",
                'Content-Type': "application/json"
            }
        }).then(result => {
            console.log("get SSH Data : ", result.data);
            var data = result.data.sshKey;
            var html = ""
            if (data.length) {
                if (sort_type) {
                    console.log("check : ", sort_type);
                    data.filter(list => list.name !== "").sort((a, b) => (a[sort_type] < b[sort_type] ? - 1 : a[sort_type] > b[sort_type] ? 1 : 0)).map((item, index) => (
                        html += '<tr onclick="showInfo(\'' + item.cspSshKeyName + '\');">' 
                            + '<td class="overlay hidden" data-th="">' 
                            + '<input type="hidden" id="ssh_info_' + index + '" value="' + item.name + '|' + item.connectionName + '"/>' 
                            + '<input type="checkbox" name="chk" value="' + item.name + '" id="raw_'  + index + '" title="" /><label for="td_ch1"></label> <span class="ov off"></span></td>' 
                            + '<td class="btn_mtd ovm" data-th="Name">' + item.id 
                            + '<a href="javascript:void(0);"><img src="/assets/img/contents/icon_copy.png" class="td_icon" alt=""/></a> <span class="ov"></span></td>'
                            + '<td class="overlay hidden" data-th="connectionName">' + item.connectionName + '</td>' 
                            + '<td class="overlay hidden" data-th="cspSshKeyName">' + item.cspSshKeyName + '</td>'  
                            + '<td class="overlay hidden" data-th=""><a href="javascript:void(0);"><img src="/assets/img/contents/icon_link.png" class="icon" alt=""/></a></td>' 
                            + '</tr>'
                    ))
                } else {
                    data.filter((list) => list.name !== "").map((item, index) => (
                        html += '<tr onclick="showInfo(\'' + item.cspSshKeyName + '\');">' 
                            + '<td class="overlay hidden" data-th="">' 
                            + '<input type="hidden" id="ssh_info_' + index + '" value="' + item.name  + '"/>'
                            + '<input type="checkbox" name="chk" value="' + item.name + '" id="raw_' + index + '" title="" /><label for="td_ch1"></label> <span class="ov off"></span></td>' 
                            + '<td class="btn_mtd ovm" data-th="id">' + item.id + '<span class="ov"></span></td>' 
                            + '<td class="overlay hidden" data-th="connectionName">' + item.connectionName + '</td>' 
                            + '<td class="overlay hidden" data-th="cspSshKeyName">' + item.cspSshKeyName + '</td>' 
                            + '<td class="overlay hidden" data-th=""><a href="javascript:void(0);"><img src="/assets/img/contents/icon_link.png" class="icon" alt=""/></a></td>' 
                            + '</tr>'
                    ))

                }

                $("#sList").empty();
                $("#sList").append(html);
                
                ModalDetail()

            }
        })
    }

    function goFocus(target) {

        console.log(event)
        event.preventDefault()

        $("#" + target).focus();
        fnMove(target)
    }

    function goDelete(target) {
        console.log(target);
    }

    function showInfo(target) {
        console.log("target showInfo : ", target);
        var sshKeyId = target;
        var apiInfo = "{{ .apiInfo}}";
        var url = CommonURL+"/ns/"+NAMESPACE+"/resources/sshKey/"+ sshKeyId;
        console.log("ssh key URL : ",url)

        return axios.get(url,{
            headers:{
                'Authorization': apiInfo
            }
        
        }).then(result=>{
            var data = result.data
            console.log("Show Data : ",data);
            
            var dtlCspSshKeyName = data.cspSshKeyName;
            var dtlDescription = data.description;
            var dtlUsername = data.username;
            var dtlConnectionName = data.connectionName;
            var dtlPublicKey = data.publicKey;
            var dtlPrivateKey = data.privateKey;
            var dtlFingerprint = data.fingerprint;


           $('#dtlCspSshKeyName').empty();
           $('#dtlDescription').empty();
           $('#dtlUsername').empty();
           $('#dtlConnectionName').empty();
           $('#dtlPublicKey').empty();
           $('#dtlPrivateKey').empty();
           $('#dtlFingerprint').empty();

           $('#dtlCspSshKeyName').val(dtlCspSshKeyName);
           $('#dtlDescription').val(dtlDescription);
           $('#dtlUsername').val(dtlUsername);
           $('#dtlConnectionName').val(dtlConnectionName);
           $('#dtlPublicKey').val(dtlPublicKey);
           $('#dtlPrivateKey').val(dtlPrivateKey);
           $('#dtlFingerprint').val(dtlFingerprint);
        })

    }

    function createSSHKey() {
        var cspSshKeyName = $("#reg_cspSshKeyName").val()
        var connectionName = $("#reg_connectionName").val()

        console.log("info param cspSshKeyName : ", cspSshKeyName);
        console.log("info param connectionName : ", connectionName);

        if (!cspSshKeyName) {
            alert("Input New SSH Key Name")
            $("#reg_cspSshKeyName").focus()
            return;
        }
        if (!connectionName) {
            alert("Input Connection Name")
            $("#reg_connectionName").focus()
            return;
        }

        var apiInfo = "{{ .apiInfo}}";
        var url = CommonURL+"/ns/"+NAMESPACE+"/resources/sshKey"
        console.log("ssh key URL : ",url)
        var obj = {
            name: cspSshKeyName,
            connectionName: connectionName
        }
        console.log("info connectionconfig obj Data : ", obj);
        if (cspSshKeyName) {
            axios.post(url, obj, {
                headers: {
                    'Content-type': 'application/json',
                    'Authorization': apiInfo,
                }
            }).then(result => {
                console.log(result);
                if (result.status == 200 || result.status == 201) {
                    alert("Success Create SSH Key")
                    //등록하고 나서 화면을 그냥 고칠 것인가?
                    getSSHList();
                    //아니면 화면을 리로딩 시킬것인가?
                    location.reload();
                    // $("#btn_add2").click()
                    // $("#namespace").val('')
                    // $("#nsDesc").val('')
                } else {
                    alert("Fail Create SSH Key")
                }
            });
        } else {
            alert("Input SSH Key Name")
            $("#reg_cspSshKeyName").focus()
            return;
        }
    }

    function ModalDetail() {
        $(".dashboard .status_list tbody tr").each(function () {
            var $td_list = $(this),
                $status = $(".server_status"),
                $detail = $(".server_info");
            $td_list.off("click").click(function () {
                $td_list.addClass("on");
                $td_list.siblings().removeClass("on");
                $status.addClass("view");
                $status.siblings().removeClass("on");
                $(".dashboard.register_cont").removeClass("active");
                $td_list.off("click").click(function () {
                    if ($(this).hasClass("on")) {
                        console.log("reg ok button click")
                        $td_list.removeClass("on");
                        $status.removeClass("view");
                        $detail.removeClass("active");
                    } else {
                        $td_list.addClass("on");
                        $td_list.siblings().removeClass("on");
                        $status.addClass("view");

                        $status.siblings().removeClass("view");
                        $(".dashboard.register_cont").removeClass("active");
                    }
                });
            });
        });
    }

    function getConnectionInfo(provider){
                var url = SpiderURL+"/connectionconfig";
                console.log("provider : ",provider)
                //var provider = $("#provider option:selected").val();
                var html = "";
                var apiInfo = ApiInfo
                axios.get(url,{
                    headers:{
                        'Authorization': apiInfo
                    }
                }).then(result=>{
                    console.log('getConnectionConfig result: ',result)
                    var data = result.data.connectionconfig
                    console.log("connection data : ",data);
                    var count = 0; 
                    var configName = "";
                    var confArr = new Array();
                    for(var i in data){
                        if(provider == data[i].ProviderName){ 
                            count++;
                            html += '<option value="'+data[i].ConfigName+'" item="'+data[i].ProviderName+'">'+data[i].ConfigName+'</option>';
                            configName = data[i].ConfigName
                            confArr.push(data[i].ConfigName)
                            
                        }
                    }
                    if(count == 0){
                        alert("해당 Provider에 등록된 Connection 정보가 없습니다.")
                            html +='<option selected>Select Configname</option>';
                    }
                    if(confArr.length > 1){
                        configName = confArr[0];
                    }
                    $("#reg_connectionName").empty();
                    $("#reg_connectionName").append(html);

                    
                })
            }
</script>
{{template "Footer" .}}